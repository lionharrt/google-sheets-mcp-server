# Dify Integration Guide\n\nThis guide shows you how to securely integrate the Google Sheets MCP Server with Dify.\n\n## üîê Security Implementation\n\n### **API Key Authentication**\n\nThe server uses a simple but secure API key authentication system:\n\n1. **Generate a strong API key** (32+ random characters)\n2. **Set the environment variable** `MCP_API_KEY=your-secure-key`\n3. **Include the key in requests** using one of these headers:\n   - `X-API-Key: your-secure-key`\n   - `Authorization: Bearer your-secure-key`\n\n### **Cloud Run Security Features**\n\n- ‚úÖ **HTTPS-only traffic** (TLS 1.2+)\n- ‚úÖ **Private Google Cloud authentication** \n- ‚úÖ **No public internet exposure** without proper headers\n- ‚úÖ **Automatic scaling and DDoS protection**\n\n## üîó Dify Configuration\n\n### **Step 1: Get Your Server URL**\n```\nhttps://google-sheets-mcp-server-biud2q65ta-uc.a.run.app/mcp\n```\n\n### **Step 2: Get Your API Key**\nThe API key is shown in the server logs when it starts. For production:\n```bash\nexport MCP_API_KEY=\"$(openssl rand -base64 32)\"\n```\n\n### **Step 3: Add MCP Server in Dify**\n\n1. Go to **Tools ‚Üí External Tools ‚Üí MCP Servers**\n2. Click **\"Add MCP Server (HTTP)\"**\n3. Configure:\n   - **Name**: `Google Sheets`\n   - **URL**: `https://google-sheets-mcp-server-biud2q65ta-uc.a.run.app/mcp`\n   - **Headers**:\n     ```json\n     {\n       \"X-API-Key\": \"your-api-key-here\",\n       \"Content-Type\": \"application/json\",\n       \"Accept\": \"application/json, text/event-stream\"\n     }\n     ```\n\n### **Step 4: Test Connection**\n\nDify should be able to:\n- ‚úÖ Initialize connection with the MCP server\n- ‚úÖ List available tools (get_sheet_data, update_cells, etc.)\n- ‚úÖ Execute Google Sheets operations\n\n## üõ†Ô∏è Available Tools\n\n| Tool | Description | Parameters |\n|------|-------------|-----------|\n| `get_sheet_data` | Read spreadsheet data | spreadsheet_id, sheet, range |\n| `update_cells` | Update cell values | spreadsheet_id, sheet, range, values |\n| `create_spreadsheet` | Create new spreadsheet | title, folder_id |\n| `list_spreadsheets` | List available spreadsheets | folder_id |\n| `add_rows` | Append data to sheet | spreadsheet_id, sheet, values |\n| `list_sheets` | List sheets in spreadsheet | spreadsheet_id |\n| `create_sheet` | Add new sheet | spreadsheet_id, title |\n| `health_check` | Server health status | none |\n\n## üîß Advanced Configuration\n\n### **Custom Authentication Headers**\nIf you need to customize authentication, you can use:\n```json\n{\n  \"Authorization\": \"Bearer your-api-key\",\n  \"X-Custom-Header\": \"additional-security\"\n}\n```\n\n### **IP Allowlisting** \nFor additional security, configure Cloud Run to only accept traffic from Dify's IP ranges.\n\n### **Monitoring**\nCloud Run provides built-in monitoring for:\n- Request latency\n- Error rates  \n- Authentication failures\n- Resource usage\n\n## üö® Security Best Practices\n\n1. **Rotate API keys regularly** (monthly recommended)\n2. **Use HTTPS only** (automatically enforced by Cloud Run)\n3. **Monitor access logs** for unusual patterns\n4. **Limit Google Sheets permissions** to minimum required\n5. **Use environment variables** for secrets (never hardcode)\n\n## üìã Troubleshooting\n\n### Common Issues:\n\n**401 Unauthorized**\n- Check that `X-API-Key` header is included\n- Verify the API key matches the server configuration\n\n**403 Forbidden** \n- API key is present but invalid\n- Check for typos in the key\n\n**500 Internal Server Error**\n- Google authentication may have failed\n- Check Cloud Run logs for detailed error messages\n\n**Connection Timeout**\n- Server may be cold-starting (normal for first request)\n- Check if the server URL is correct
